

# コールバック関数のセットアップAPI



以下の関数を使用して、ユーザー認証コールバック関数を設定します。



## ユーザー認証コールバック関数の設定


```
void wolfSSH_SetUserAuth(WOLFSSH_CTX* ctx , WS_CallbackUserAuth
cb );
```

コールバック関数は、WolfSSHセッションオブジェクトの作成に使用されるwolfSSL CTXオブジェクトに設定されています。このCTXを使用するすべてのセッションは、同じCallBackFunctionを使用します。このコンテキストは、コールバック関数のコンテキストと混同しないでください。



## ユーザー認証コールバックコンテキストデータの設定


```
void wolfSSH_SetUserAuthCtx(WOLFSSH* ssh , void* ctx );
```

各WOLFSSHセッションには、独自のユーザー認証コンテキストデータがあるか、一部を共有する場合があります。wolfSSHライブラリーは、このコンテキストデータの内容については何も知りません。作成、リリース、必要に応じてデータにミューテックスを提供するのはアプリケーション次第です。コールバックは、ライブラリからこのコンテキストデータを受信します。



## ユーザー認証コールバックコンテキストデータを取得します


```
void* wolfSSH_GetUserAuthCtx(WOLFSSH* ssh );
```

これにより、提供されたwolfSSHセッションに保存されているユーザー認証コンテキストデータへのポインターが返されます。これは、セッションの作成に使用されるwolfSSHのコンテキストデータと混同しないでください。



## ECHOサーバーユーザー認証の例



Echo Serverの例は、パスワードとパブリックキーを使用してサンプルユーザーを使用した認証コールバックを実装しています。コールバックの例であるWsuserauthは、wolfSSHのコンテキストに設定されています。

```
wolfSSH_SetUserAuth(ctx, wsUserAuth);
```

パスワードファイルの例(passwd.txt)は、それぞれコロンで分離されたユーザー名とパスワードの簡単なリストです。このファイルに存在するデフォルトは次のとおりです。



```   
jill:upthehill
jack:fetchapail
```

公開キーファイルは、SSH-Keygenを2回実行する公開キーの出力の連結です。



```
ssh-rsa AAAAB3NzaC1yc...d+JI8wrAhfE4x hansel
ssh-rsa AAAAB3NzaC1yc...UoGCPIKuqcFMf gretel
```

すべてのユーザーの承認データは、パスワードまたは公開キーBLOBのユーザー名とSHA-256ハッシュのペアのリンクリストに保存されます。


構成ファイルの公開キーブロブは、base64エンコードされており、ハッシュ前にデコードされます。ユーザー名ハッシュペアのリストへのポインターは、新しいwolfSSHセッションに保存されます。

```
wolfSSH_SetUserAuthCtx(ssh, &pwMapList);
```
Callback関数は、AuthTypeが公開キーまたはパスワードのいずれかであるかどうかを最初にチェックし、どちらも場合は一般ユーザー認証障害エラーコードを返します。次に、AuthDataを介して渡された公開キーまたはパスワードをハッシュします。次に、ユーザー名を見つけようとしてリストを通過し、見つからない場合は無効なユーザーエラーコードを返します。見つかった場合、それは渡された公開キーまたはパスワードの計算されたハッシュとペアに保存されたハッシュを比較します。それらが一致する場合、関数は成功を返し、それ以外の場合は無効なパスワードまたは公開キーエラーコードを返します。
